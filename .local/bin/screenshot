#!/usr/bin/env bash
filename=$HOME/Pictures/Screenshots/$(date +'Screenshot_%Y-%m-%d_%H-%M-%S.png')
lockdir=/var/tmp/swayScreenshot
lockpath=/var/tmp/swayScreenshot/lockfile
tmpregion=$(mktemp --tmpdir=$lockdir --dry-run)
monitor=$(swaymsg -t get_outputs | jq -r '.[] | select(.focused) | .name')

freezeGuarantee() { #i hope its guaranteed at least
if command -v hyprpicker > /dev/null; then
    hyprpicker -r -n -z -q &
    false
    until [ $? -eq 0 ]; do
        swaymsg -r -t get_outputs | jq '.[0].layer_shell_surfaces | .[] | .namespace' | grep hyprpicker &>/dev/null
    done
fi
}

slorp () {
time1=$(date +%s%3N)
until [ ! -z "$area" ]; do
    area=$(slurp -d -c ffffffff -b 00000088 -w 3)
    time2=$(date +%s%3N)
    elapsed=$(($time2-$time1))
    if [[ $elapsed -gt 250 ]]; then
        break
    fi
    time1=$time2
done
}

if mkdir $lockdir 2>/dev/null && touch $lockpath 2>/dev/null; then
trap 'rm -rf $lockdir & killall hyprpicker 2>/dev/null' EXIT

case $1 in
    --region)
        type="Region"
        freezeGuarantee
        slorp
        if [ ! -z "$area" ]; then
            grim -l 1 -g "$area" $tmpregion 
            magick $tmpregion -shave 4x4 PNG:$filename
        fi
    ;;

    --display)
        type="$monitor"
        grim -l 1 -o "$monitor" $filename
    ;;

    --all)
        type="Desktop"
        grim -l 1 $filename
    ;;

    *)
        echo "
    Flags:

        --region (Screenshots a selected region)
        --display (Screenshots current active monitor)
        --all (Screenshots all monitors/entire desktop)

    why are you using this in your terminal anyways
        "
        notify-send "Screenshot Error" "Flag written incorrectly"
    ;;
esac

else
    echo "Remove $lockdir directory"
fi

if [ -f "$filename" ]; then
    wl-copy < $filename &
    $(notify-send "$type Screenshot" "Saved to $filename" --icon=$filename -a Screenshot -u critical -A "xdg-open $filename=View screenshot") &
    paplay $HOME/.config/swaync/se_elevator_ding.ogg --volume=65535 &
fi

exit
